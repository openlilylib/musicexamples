%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                         %
%      This file is part of the 'openLilyLib' library.                    %
%                                ===========                              %
%                                                                         %
%              https://github.com/lilyglyphs/openLilyLib                  %
%                                                                         %
%  Copyright 2012-13 by Urs Liska, lilyglyphs@ursliska.de                 %
%                                                                         %
%  'openLilyLib' is free software: you can redistribute it and/or modify  %
%  it under the terms of the GNU General Public License as published by   %
%  the Free Software Foundation, either version 3 of the License, or      %
%  (at your option) any later version.                                    %
%                                                                         %
%  This program is distributed in the hope that it will be useful,        %
%  but WITHOUT ANY WARRANTY; without even the implied warranty of         %
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the           %
%  GNU General Public License for more details.                           %
%                                                                         %
%  You should have received a copy of the GNU General Public License      %
%  along with this program.  If not, see <http://www.gnu.org/licenses/>.  %
%                                                                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[../openLilyLib]{subfiles}

\begin{document}

\part{musicexamples.sty\\\LaTeX{} Package}


\begin{authorAbstract}{Urs Liska}
\texttt{musicexamples} is a set of tools intended for printing and managing music examples in \LaTeX{} documents.
It was developed with examples in mind that are produced using the LilyPond notation software%
\footnote{\url{www.lilypond.org}},
but it can also be used to handle any kind of images.

It consists of three parts: a \LaTeX{} package, a set of configuration files for LilyPond scores and a set of Python scripts (to be implemented).
\end{authorAbstract}

\vfill
\input{copyright-notice.inp}

\tableofcontents

\chapter{End User Documentation}
\section{Installation and Requirements}

\section{musicexamples.sty}
\label{sec:xmp_musicexamples}

\texttt{musicexamples} is a \LaTeX{} package that defines environments and commands to handle music examples (scores and fragments) within \LaTeX{} documents.
It supports floating or non-floating examples as well as full-(one- or multi-)page scores.
The examples are numbered in one contigious list and can be output as one \cmd{listofmusicexamples}, regardless of their type of inclusion.

The package was developed from the perspective of a user of the LilyPond notation software%
\footnote{\url{http://www.lilypond.org}}, but you can use it with any kind of suitable music example images.
The package has some similarities with LilyPond's \package{lilypond-book} script, but it doesn't understand itself as a competitor for this, but rather as a different approach for people with somewhat different needs.
It can even be used in parallel, i.\,e.\ you can use \package{musicexamples'} environments to wrap \package{lilypond-book}-like source snippets.
For anybody writing (about) music it may also be a good idea to have a look at my \package{lilyglyphs} package that will eventually be merged into the openLilyLib family of resources.

The following documentation is split into “basic” and “advanced” usage sections because there are basic possibilities that you can use without bothering about the advanced ones.
Especially you are in no way forced to use LilyPond as the source of your music examples (although I can't recommend it highly enough \dots).
In the basic “mode” you can simply use \package{musicexamples} as a tool to number and list your music examples.

\subsection{Basic Usage}
\label{subsec:xmp_basic-usage}
In order to use \texttt{musicexamples} you simply write \cmd{usepackage\{musicexamples\}} or \cmd{RequirePackage\{musicexamples\}}.
You will then have access to its commands and environments:

There are two environments to be used for non-fullpage music examples: \env{musicexample} and \env{musicexampleNonFloat}.
The point of having a non-floating environment is \emph{not} to have more control over the placement of the item, but rather to allow it to cross page breaks, so that a group of music systems may flow over one or more pages. 
These environments do not print the music examples themselves but only provide the environment for them (as a \texttt{figure} environment doesn't already print the figure), managing their placement, captions, numbering and listing.

You use \env{musicexample} like any other float environment, so you can optionally add the placement directive after the \cmd{begin} statement (of the floating version).
Inside the environment you add the contents, the \cmd{caption} to be used, and a \cmd{label}.
\begin{quote}
\begin{verbatim}
\begin{musicexample}[t]
  \includegraphics{exampleimage}
  \caption{A typical music example}
  \label{xmp:typical-example}
\end{musicexample}
\end{verbatim}
\end{quote}

This will print your image in a floating environment [preferrably at the top of a page], will take care of the numbering and prepares for the inclusion in a list of music examples.
If you have loaded the \package{fancyref} package you can profit from the predefined set of reference strings for the new \texttt{xmp:} prefix shown in the example.
There are also German strings provided if you load \package{fancyref} with the \texttt{german} option, but this doesn't work yet \ghIssue{5}.

The usage of \texttt{musicexampleNonFloat} is identical, except that it doesn't accept the optional placement argument.
It will print the example right where you inserted the environment, and while the floating version can only print the example in a box on a single page, this one can spread over page breaks -- provided the music systems are given as separate images.

The captions are (to my knowledge) standard captions that can be influenced (formatted) with the commands of the \texttt{caption} package (please refer to its documentation), the default layout and style being due to my needs when developing the package.
The caption label defaults to “Music Example”, to change this you can use the command \cmd{setXmpCaptionLabel} with one mandatory argument supplying the desired string.
\begin{quote}
\begin{verbatim}
\setXmpCaptionLabel{Notenbeispiel}
\end{verbatim}
\end{quote}

The \package{newfloat} package that was used to define the new floating environment offers a nice feature:
If you have loaded certain other packages it will automagically create some other commands of floating environments for you.
They behave the same as their standard counterparts, and for further information please refer to the respective package documentation.

\begin{description}
\item[\cmd{wrapmusicexample}] is created by loading the \texttt{wrapfig} package.
It will create a floating music example that is wrapped by the continuous text.
\item[\cmd{sidewaysmusicexample}] is created by loading the \texttt{rotating} package.
It will create a music example that is rotated so you can use examples with a landscape page layout.
\item[\cmd{SCmusicexample}] is created by loading the \texttt{sidecap} package.
It will create a music example with the caption placed beside.
\item[{\cmd{FPmusicexample}}] is created by loading the \texttt{fltpage} package.
It will create a music example with the caption placed on the previous or next page.
As \texttt{musicexamples} offers its own solution for full-page music examples (see below) you probably won't need this.
\end{description}

The \cmd{fullPageMusicExample} command gives you the possibility to include full-page scores with one ore more pages.
It behaves differently from the above \emph{environments} in that it is a \emph{command} -- and in that it actually inserts the example in the document instead of only providing its environment.
The command expects three mandatory arguments: 
\# 1: the file name (including the relative path) to a pdf (and no other image) file.
\#2: the caption and \#3: the label.

Internally the pages are included using \cmd{includepdf} and the \package{afterpage} package, so the score will start at the next page without leaving the rest of the current page empty.
The label will be placed correctly on the new page so references will be correct.
The caption is printed in the header or footer of the (first) page of the example.
This is realized through the use of the \package{scrpage2} package from \package{KOMA-Script}.
The pagestyle for the first page is set to the predefined \env{xmpPageOne} while the remaining pages are assigned \env{xmpPageTwo}.
By default the caption is printed on the left (or inner) part of the header of the first page, while the page number is centered in the footer.
The caption is styled manually within this page style.
If you want to adapt these formats (page layout or caption formatting) you will have to redefine one or both formats using \cmd{deftripstyle} (see the KOMA-Script documentation for details).
\begin{knownIssues}
The pdf pages are included “as-is”, so nothing is done about page layout and margins.
The document/score author is responsible for providing suitably laid out scores.
But with two-sided layout there is no way (so far) to take care of the correct inner and outer margins.
Hopefully there will be some assistance implemented in the LilyPond configuration files for this, and maybe we'll implement the possibility to include “cropped“ scores (without page margins) that can be scaled into the text area of the \LaTeX{} document.

So far the score will start on the \emph{next} page, but it is intended to implement an option to explicitely start at the next odd or even page \ghIssue{10}.
\end{knownIssues}

\bigskip
Music examples entered by any of the above environments or commands are numbered in one list (they share the counter \env{musicexamples}).
You can create a list of music examples just as you would create a list of tables or figures with the command \cmd{listofmusicexamples}.
The list title defaults to “List of Music Examples” and can be changed using \cmd{setXmpListName}.


\subsection{Advanced Usage}
\label{subsec:xmp_advanced-usage}

There are several commands that are intended to actually print music examples within these two environments -- although you can of course print any images inside (as in the first example).
\cmd{musicSFE} and \cmd{lilypondSFE} are used to print Single File Examples, which usually consist of one single music system.
Technically they consist of one \emph{file}, but it is recommended not to mix these concepts arbitrarily.
As with other commands there are “music” and “lilypond” versions of it, which  you should use to distinguish between music examples provided by arbitrary image files and examples generated by LilyPond.
From \LaTeX's point of view they are the same (the “lilypond” version calls the other one internally), but a Python script can use them to keep track of the LilyPond generated examples.
\todo{Note: The script hasn't been implemented yet.}

You use both commands by providing the file basename as the single argument, including the relative path but excluding the extension.
Internally these commands include the example with \cmd{includegraphics}, and you can pass an optional argument with the same options that you can use to include images normally.
Usually it is recommendable to prepare the images in advance and include them unaltered in order to get a consistent layout.

\todo{It is intended to implement a conditional resizing that scales the image only if it exceeds the text height or width.}

\begin{quote}
\begin{verbatim}
\lilypondSFE[scale=1.2]{examples/lilypond/example1}
\end{verbatim}
\end{quote}

\cmd{lilypondMFE} is used to print a Multi File Example generated by LilyPond.
There is no “music“ variant of this command because it expects a series of music systems in a form that is typical for LilyPond's \texttt{lilypond-book} style output.
(We will discuss some aspects on how to streamline the creation of these examples on the LilyPond side later in \fref{sec:lilypond-configuration}).
If you have a music examples consisting of several individual image files you can still use \cmd{musicSFE} multiple times to print them manually.

To use \cmd{lilypondMFE} you provide it the file basename as the mandatory argument, just like with the other commands we saw so far.
To work correctly the command expects a set of files to be present at the location specified by the argument.
These are the files that you'll find when you include the file \texttt{lilypond-book-preable.ly} in your LilyPond document:
\begin{description}
\item[\texttt{BASENAME-\#(.pdf)}] Numbered files for each system.
The music systems start with \#\,3, while the first two files are the book and score title markups, which are discarded by the command.
If you need to have titles you will have to supply them directly within the music example environment.
\item[\texttt{BASENAME-systems.count}] is a file containing exclusively one number indicating the number of systems to be processed.
\end{description}

\cmd{lilypondMFE} will now iterate over the files 3 to n to consecutively print the systems using the \cmd{musicSFE} command.

\todo{It is intended to implement some optional element between consecutive systems (just as  \texttt{lilypond-book} does).}


\section{The LilyPond Configuration Files}
\label{sec:lilypond-configuration}

\section{The Python Scripts}

\chapter{Implementation}

\section{musicexamples.sty}

\section{LilyPond Files}

\chapter{Licenses}
\input{licenses.inp}

\end{document}