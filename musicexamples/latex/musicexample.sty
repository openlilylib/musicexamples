%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                         %
%      This file is part of the 'openLilyLib' library.                    %
%                                ===========                              %
%                                                                         %
%              https://github.com/lilyglyphs/openLilyLib                  %
%                                                                         %
%  Copyright 2012-13 by Urs Liska, lilyglyphs@ursliska.de                 %
%                                                                         %
%  'openLilyLib' is free software: you can redistribute it and/or modify  %
%  it under the terms of the GNU General Public License as published by   %
%  the Free Software Foundation, either version 3 of the License, or      %
%  (at your option) any later version.                                    %
%                                                                         %
%  This program is distributed in the hope that it will be useful,        %
%  but WITHOUT ANY WARRANTY; without even the implied warranty of         %
%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the           %
%  GNU General Public License for more details.                           %
%                                                                         %
%  You should have received a copy of the GNU General Public License      %
%  along with this program.  If not, see <http://www.gnu.org/licenses/>.  %
%                                                                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Infrastructure to deal with music examples.
% Intended for use with LilyPond documents,
% but works with any images basically
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{musicexample}

% Allow definition of the new float environment
\RequirePackage{newfloat}

% Include the following packages
% to automatically provide versions of the environment4
% (feature of the newfloat package):
% - fltpage  -> FPmusicexample (caption on different page) 
% - rotating -> sidewaysmusicexample (rotated example)
% - sidecap  -> SCmusicexample (caption besides the example)
% - wrapfig  -> wrapmusicexample (example with text floating around it)
%
% See the documentation of the packages for more information

% Allow definition of new pagestyles for fullpage examples
\RequirePackage{scrpage2}

% Format the captions of the float environment
% (Try making the coherent with the manually typeset captions
%  of the non-float items)
\RequirePackage{caption}

% Allow reading the contents of an auxiliary file.
% Needed for multi-system-examples, where the number of systems
% is written to a ...systems.count file by LilyPond
\RequirePackage{catchfile}

% Loop through the systems of a multi-system example
\RequirePackage{forloop}

% Define variables to make the text parts configurable
% wrap this one in a command because it will be used in different places.
% Not to be used by the document author
\newcommand*{\ollXmpCaptionLabel}{Music Example}
% Use the following two commands to adapt the respective 
% strings to your needs (i.e. mostly language)
\newcommand*{\setXmpCaptionLabel}[1]{%
	\renewcommand{\ollXmpCaptionLabel}{#1}%
	\SetupFloatingEnvironment{musicexample}{name=#1}}
\newcommand*{\setXmpListName}[1]{%
	\SetupFloatingEnvironment{musicexample}{listname=#1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Lowlevel printing commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% The following commands are used to print music examples
% without keeping track of them or numbering them.
% While it is perfectly possible to directly include image files
% instead, it is advisable to use them as a consistent interface

% \musicSFE
%
% SingleFileExample (generic file)
% Print a music example consisting of a single file
% (typically one system, but can also be used
%  for an arbitrary image file).
% Places the image in a separate paragraph
% and suppresses indentation.
% If the image is wider than \texwidth, 
% it is scaled to fit he text column.
%TODO implement the optional downscaling to \textwidth
%     (should also issue a warning)
\newcommand{\musicSFE}[2][]{

	\includegraphics[#1]{#2}

}

% \lilypondSFE
%
% SingleFileExample (Lilypond file)
% Use this for Lilypond examples that consist of single files.
% While the command actually treats them as ordinary images
% one can use this for a script to keep track
% of changed sources that should be recompiled.
\newcommand{\lilypondSFE}[2][]{
	\musicSFE[#1]{#2}
}

% \lilypondMFE
%
% MultiFileExample (LilyPond generated)
% Use this for music examples consisting of multiple systems
% Provide the basename (including relative path but without extension)
% as the mandatory argument.
% The command will then iterate over the found subfiles
% (as determined by LilyPond's .systems.count file)
% and include them as \musicSystem-s
%
% Store the number of systems in the MFExample
\newcounter{lilySysCnt}
% forloop index
\newcounter{lilySysInd}
% This command should not be called directly,
% but rather the below macro (with the consistently
% capitalized name).
\newcommand{\lilypondmfe}[2][]{
	% (Use catchfile to set lilySysCnt to the number inside
	% LilyPonds -systems.count file)
	\CatchFileDef{\scfftemp}{#1-systems.count}{\endlinechar=-1 }%
	\setcounter{lilySysCnt}{\scfftemp}
	% Increment counter for the forloop comparison
	\stepcounter{lilySysCnt}
	% Iterate over the found music systems
	% (start with 3 because 1 and 2 are only the titles)
	% and include them as \musicSFE systems
	\forloop{lilySysInd}
		{3}
		{\value{lilySysInd} < \value{lilySysCnt}}
		{\musicSFE[#1]{#2-\arabic{lilySysInd}}}
	\endgroup % (End the group started by \lilypondMFE)
}

% Call this macro in the document
% It starts a group and changes the catcode of the underscore.
% This way you can use underscores in the filename.
\def\lilypondMFE{%
	\begingroup
	\catcode`\_=12
	\lilypondmfe
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Interface for tracked music examples
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% A) Non-fullpage example environments

%TODO Include the following example types in the \listof{musicExample}
%     (at least write a line to the aux file)

% musicExample
%
% Float type for placing music examples
% Place one or more of the above lowlevel 
% commands inside the environment
% and provide a \caption and \label inside
%
% First declare an internal floating environment
% (this will be the common counter)
\DeclareFloatingEnvironment[%
	fileext=loxmp,
	listname={List of Music Examples},
	name={\ollXmpCaptionLabel},
	placement=htpb]
	{musicexample}

% Define default alignment of music example environments
\newcommand*\xmpAlignment{\center}
% Change the alignment of music examples
\newcommand{\setXmpAlignment}[1]{%
	\renewcommand*\xmpAlignment{#1}
}
% Now this is the environment to be used in a document:
\newenvironment{musicExample}{%
	\begin{musicexample}
	\xmpAlignment
}{%
	\end{musicexample}
}

% musicExampleNonFloat
%
% Non float version of a music example
% While one can also use musicexample with the [H] option to 
% place it HERE, this non-floating environment is
% necessary to use multiline examples that may span
% line break(s).
% Place one or more of the above lowlevel 
% commands inside the environment
% and provide a \label.
% As it isn't a float environment,
% you have to provide the caption as a mandatory argument #1
\newenvironment{musicExampleNonFloat}
	{%
		\bigskip
		\xmpAlignment
		\captionsetup{type=musicexample}
	}{%

	\medskip
	}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% B) Full-page example environments

% With full-page examples the numbering and caption is realized
% using the header/footer of the first (or only) page
% (by use of scrpage2 from KOMA-Script).
% The following predefined pagestyles places the caption
% in the inner/left part of the header (for the first page) 
% and the page number centered in the footer.
% To change this to your needs, you only have to 
% redefine the xmpPageOne and xmpPageTwo styles afterwards
% using \deftripstyle again (see the KOMA-Script documentation).
\deftripstyle{xmpPageOne}%
	{\upshape\ollXmpCaptionLabel \arabic{musicexample}: \xmpCaption}{}{}%
	{}{--\,\pagemark\,--}{}

\deftripstyle{xmpPageTwo}%
	{}{}{}%
	{}{--\,\pagemark\,--}{}

% \fullPageMusicExample
%
% Includes a full-page music example with one or more pages.
% The document author is responsible to provide files with suitable page margins
% as there isn't a suitable mechanism yet to adapt it
% (especially not for right/left layout)
% The caption is printed in the header or footer of the (first) page
% using the scrpage2 mechanism.
% The \pagestyle for the first page is set to "xmpPageOne",
% while the \pagestyle for any following page is set to "xmpPageTwo".
% Arguments:
% #1 - file name (including path but without .pdf extension)
% #2 - Caption to be printed
% #3 - label (including 'xmp:')

% Counter indexing the processed pages of a full page example
\newcounter{xmpPageInd}
\newcommand{\fullPageMusicExample}[3]{%
	% Restart page counter
	\setcounter{xmpPageInd}{0}
	% Increment music example counter manually
	\refstepcounter{musicexample}
	% Set the caption text for use in the page style
	\def\xmpCaption{#2}
	\afterpage{
		% The following two commands have to be placed after the \afterpage
		% command to give the right page number
		% Manually add an entry in the index file
		\addcontentsline{loxmp}{musicexample}{\protect\numberline{\arabic{musicexample}}{\ignorespaces #2\relax }}%%
		\label{#3}
		\includepdf[%
			pages=-,
			pagecommand={%
				\stepcounter{xmpPageInd}
				\ifthenelse{\value{xmpPageInd} = 1}
					{\thispagestyle{xmpPageOne}}
					{\thispagestyle{xmpPageTwo}}	
			}]{#1}
	}
}

% \fullPageLilypondExample
%
% The same as \fullPageMusicExample (which it calls).
% Used for keeping track of LilyPond generated music examples.
\newcommand{\fullPageLilypondExample}[3]{%
	\fullPageMusicExample{#1}{#2}{#3}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Enable fancyref to work with music examples
% (you will have to use the fancyref package manually)
% Then you can write \fref{xmp:your-label}

\newcommand*{\fancyrefxmplabelprefix}{xmp}

\fancyrefaddcaptions{english}{%
  \providecommand*{\frefxmpname}{example}
  \providecommand*{\Frefxmpname}{Example}
}

\fancyrefaddcaptions{german}{%
  \providecommand*{\frefxmpname}{Notenbeispiel}
  \providecommand*{\Frefxmpname}{Notenbeispiel}
}

\frefformat{plain}{\fancyrefxmplabelprefix}{\frefxmpname\fancyrefdefaultspacing#1}
\Frefformat{plain}{\fancyrefxmplabelprefix}{\Frefxmpname\fancyrefdefaultspacing#1}

\frefformat{vario}{\fancyrefxmplabelprefix}{%
  \frefxmpname\fancyrefdefaultspacing#1#3%
}
\Frefformat{vario}{\fancyrefxmplabelprefix}{%
  \Frefxmpname\fancyrefdefaultspacing#1#3%
}
